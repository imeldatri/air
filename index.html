<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aplikasi Edukasi Daur Air</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk Ikon Navigasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Mengatur font utama dan menghilangkan scrollbar pada body */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            touch-action: none;
        }
        /* Custom Scrollbar untuk Materi */
        .content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .content-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .content-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Efek Glassmorphism untuk overlay info */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .title-font {
            font-family: 'Fredoka', sans-serif;
        }
        /* Efek Shadow untuk tombol utama di halaman Home */
        .main-button {
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .main-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- MAIN CONTENT AREA -->
    <main class="flex-grow relative w-full overflow-hidden">

        <!-- LAYER 0: BERANDA (HOME SCREEN) - Tiga tombol dijejerkan di sini -->
        <section id="view-home" class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-blue-600 p-8">
            <div class="text-center text-white mb-12">
                <div class="text-7xl mb-4 title-font">üíß</div>
                <h1 class="text-4xl md:text-6xl font-extrabold title-font mb-3">Siklus Air Bumi</h1>
                <p class="text-lg opacity-80">Pilih mode belajar yang kamu inginkan.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
                <!-- Tombol 1: Simulasi -->
                <button onclick="switchTab('simulation')" class="main-button bg-green-500 text-white p-8 rounded-2xl flex flex-col items-center hover:bg-green-600">
                    <i class="fa-solid fa-earth-americas text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Simulasi Interaktif</span>
                    <span class="text-sm opacity-90 mt-1">Lihat proses air secara visual.</span>
                </button>

                <!-- Tombol 2: Materi -->
                <button onclick="switchTab('materi')" class="main-button bg-orange-500 text-white p-8 rounded-2xl flex flex-col items-center hover:bg-orange-600">
                    <i class="fa-solid fa-book-open text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Rangkuman Materi</span>
                    <span class="text-sm opacity-90 mt-1">Baca penjelasan setiap tahap.</span>
                </button>

                <!-- Tombol 3: Kuis (Akses ke layer kuis terpisah) -->
                <button onclick="switchTab('quiz')" class="main-button bg-indigo-500 text-white p-8 rounded-2xl flex flex-col items-center hover:bg-indigo-600">
                    <i class="fa-solid fa-graduation-cap text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Uji Pengetahuan (Kuis)</span>
                    <span class="text-sm opacity-90 mt-1">Tes pemahamanmu!</span>
                </button>
            </div>
        </section>
        
        <!-- LAYER 1: SIMULASI CANVAS -->
        <section id="view-simulation" class="absolute inset-0 w-full h-full hidden">
            <canvas id="waterCycleCanvas" class="block cursor-pointer"></canvas>
            
            <!-- Tombol Kembali ke Beranda (Top Left) -->
            <button onclick="switchTab('home')" class="absolute top-4 left-4 z-50 p-3 bg-white/90 rounded-full shadow-lg text-blue-600 hover:bg-white transition">
                <i class="fa-solid fa-home"></i> <span class="hidden sm:inline font-semibold ml-1">Beranda</span>
            </button>

            <!-- Status Terkini Panel (Top Right) -->
            <div class="absolute top-4 right-4 pointer-events-none flex flex-col items-end space-y-3 z-10">
                <div class="glass-panel rounded-xl p-3 shadow-md pointer-events-auto max-w-[200px] md:max-w-xs">
                    <h1 class="text-lg font-bold text-blue-800 title-font">Status Terkini</h1>
                    <div class="text-xs text-gray-600 font-semibold mt-1" id="day-night-status">Waktu: Pagi</div>
                    <p class="mt-2 text-[10px] text-blue-600 italic">üëÜ Klik Laut (uap) atau Awan (hujan)!</p>
                </div>
            </div>
            
            <!-- Kuis CTA (Bottom Left - Akses ke layer kuis terpisah) -->
            <div class="absolute bottom-6 left-4 z-10 pointer-events-auto">
                <button onclick="switchTab('quiz')" class="main-button bg-indigo-500 text-white p-3 md:p-4 rounded-xl shadow-lg hover:bg-indigo-600 font-bold text-sm md:text-base flex items-center gap-2 transition transform hover:scale-[1.05]">
                    <i class="fa-solid fa-graduation-cap"></i> UJI PEMAHAMAN (KUIS)
                </button>
            </div>

            <!-- Kontrol Zoom (Bottom Right) -->
            <div class="absolute bottom-6 right-4 flex flex-col space-y-2 z-10 pointer-events-auto hidden">
                <button id="zoomInBtn" class="w-10 h-10 bg-white/90 rounded-full text-blue-600 font-bold shadow-lg hover:bg-white flex items-center justify-center text-xl">+</button>
                <button id="zoomOutBtn" class="w-10 h-10 bg-white/90 rounded-full text-red-500 font-bold shadow-lg hover:bg-white flex items-center justify-center text-xl">-</button>
            </div>
        </section>

        <!-- LAYER 2: MATERI (RANGKUMAN) -->
        <section id="view-materi" class="absolute inset-0 w-full h-full bg-white hidden overflow-y-auto content-scroll pb-20">
            <!-- Tombol Kembali ke Beranda (Sticky agar tetap terlihat saat scroll) -->
            <button onclick="switchTab('home')" class="sticky top-4 left-4 z-50 p-3 bg-white/90 rounded-full shadow-lg text-blue-600 hover:bg-white transition ml-4 mt-4">
                <i class="fa-solid fa-home"></i> <span class="hidden sm:inline font-semibold ml-1">Beranda</span>
            </button>

            <div class="max-w-3xl mx-auto p-6 md:p-10">
                <header class="mb-8 text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-blue-600 title-font mb-2">Rangkuman Materi</h2>
                    <p class="text-gray-500">Memahami bagaimana air bergerak di bumi.</p>
                </header>

                <!-- Kartu Materi 1: Evaporasi -->
                <div class="bg-orange-50 rounded-2xl p-6 mb-6 border-l-4 border-orange-400 shadow-sm">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-xl mr-3">‚òÄÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-800">1. Evaporasi (Penguapan)</h3>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Proses di mana air yang ada di laut, rawa, sungai dan lainnya berubah menjadi uap air karena adanya <strong>panas matahari</strong>. Dalam hal ini, air diubah dari wujud cair menjadi wujud gas (uap air) yang kemudian naik ke atmosfer.
                    </p>
                </div>

                <!-- Kartu Materi 2: Transpirasi -->
                <div class="bg-green-50 rounded-2xl p-6 mb-6 border-l-4 border-green-500 shadow-sm">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl mr-3">üå≤</div>
                        <h3 class="text-xl font-bold text-gray-800">2. Transpirasi</h3>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Mirip dengan evaporasi, namun penguapan ini terjadi pada jaringan makhluk hidup, terutama <strong>tumbuhan</strong>. Air diserap oleh akar tanaman dan kemudian dilepaskan kembali ke udara melalui daun sebagai uap air.
                    </p>
                </div>

                <!-- Kartu Materi 3: Kondensasi -->
                <div class="bg-blue-50 rounded-2xl p-6 mb-6 border-l-4 border-blue-400 shadow-sm">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl mr-3">‚òÅÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-800">3. Kondensasi (Pengembunan)</h3>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Perubahan wujud uap air menjadi titik-titik air di atmosfer. Hal ini terjadi ketika uap air naik ke ketinggian tertentu di mana suhunya lebih dingin, sehingga membentuk <strong>awan</strong>.
                    </p>
                </div>

                <!-- Kartu Materi 4: Presipitasi -->
                <div class="bg-indigo-50 rounded-2xl p-6 mb-6 border-l-4 border-indigo-500 shadow-sm">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-xl mr-3">üåßÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-800">4. Presipitasi (Hujan)</h3>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Ketika awan sudah terlalu jenuh dengan titik-titik air, air tersebut akan jatuh kembali ke permukaan bumi. Bentuk presipitasi bisa berupa <strong>hujan air</strong>, salju, atau hujan es, tergantung pada suhu udara.
                    </p>
                </div>

                <!-- Kartu Materi 5: Infiltrasi -->
                <div class="bg-amber-50 rounded-2xl p-6 mb-12 border-l-4 border-amber-600 shadow-sm">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-xl mr-3">üíß</div>
                        <h3 class="text-xl font-bold text-gray-800">5. Infiltrasi (Penyerapan)</h3>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Air hujan yang jatuh ke daratan akan meresap ke dalam tanah melalui pori-pori tanah dan batuan. Air ini menjadi <strong>air tanah</strong> yang nantinya bisa mengalir kembali ke laut atau diserap oleh tanaman.
                    </p>
                </div>
                
                <!-- CTA for Quiz in Materi (Mengarah ke layer kuis terpisah) -->
                <div class="mt-12 p-8 bg-indigo-50 rounded-2xl border-2 border-indigo-200 text-center shadow-lg">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-4 title-font">Saatnya Menguji Ilmu!</h3>
                    <p class="text-indigo-600 mb-6">Setelah membaca materi, segera cek pemahaman Anda dengan 10 soal kuis yang telah kami sediakan.</p>
                    <button onclick="switchTab('quiz')" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                        <i class="fa-solid fa-graduation-cap mr-2"></i> Mulai Kuis Sekarang
                    </button>
                </div>
            </div>
        </section>

        <!-- LAYER 3: KUIS INTERAKTIF (LAYAR TERPISAH DENGAN SATU LAYER ALUR) -->
        <section id="view-quiz" class="absolute inset-0 w-full h-full bg-slate-50 hidden overflow-y-auto pb-20 flex flex-col items-center justify-center">
            <!-- Tombol Kembali ke Beranda -->
            <button onclick="switchTab('home')" class="absolute top-4 left-4 z-50 p-3 bg-white/90 rounded-full shadow-lg text-blue-600 hover:bg-white transition">
                <i class="fa-solid fa-home"></i> <span class="hidden sm:inline font-semibold ml-1">Beranda</span>
            </button>
            
            <div id="quiz-container" class="w-full max-w-lg p-6 mt-16 md:mt-0">
                
                <!-- Tampilan Kuis Utama (Mulai dengan pertanyaan pertama) -->
                <!-- Ini adalah Layer Tunggal yang menggantikan Start Card dan Question Card secara default -->
                <div id="question-card" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 transform transition-all duration-300">
                    <div class="flex justify-between items-center mb-4 text-sm font-semibold text-slate-400">
                        <span id="q-progress">Pertanyaan 1/10</span>
                        <span id="q-score" class="text-blue-600">Skor: 0</span>
                    </div>
                    <h3 id="q-text" class="text-xl font-bold text-slate-800 mb-6 leading-snug">Klik Mulai Kuis untuk memulai...</h3>
                    <div id="q-options" class="space-y-3">
                        <!-- Tombol Mulai Kuis yang terintegrasi di sini -->
                        <button onclick="startQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105">
                            <i class="fa-solid fa-play mr-2"></i> Mulai Kuis
                        </button>
                    </div>
                </div>

                <!-- Layer RESULT/REVIEW (Hanya muncul saat kuis selesai) -->
                <div id="result-card" class="hidden bg-white rounded-2xl shadow-xl p-8 text-center animate-pop absolute inset-0 w-full h-full flex flex-col justify-center items-center">
                    <div id="result-emoji" class="text-6xl mb-4">üèÜ</div>
                    <h3 id="result-title" class="text-2xl font-bold text-slate-800 mb-2">Selamat!</h3>
                    <p class="text-slate-600 mb-6">Kamu telah menyelesaikan kuis.</p>
                    
                    <div class="bg-blue-50 rounded-xl p-4 mb-6">
                        <span class="block text-sm text-blue-400 font-bold uppercase tracking-wider">Skor Akhir</span>
                        <span id="final-score" class="text-4xl font-extrabold text-blue-600">0/0</span>
                    </div>

                    <button onclick="switchTab('home')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105">
                        Kembali ke Beranda
                    </button>
                    <button onclick="restartQuiz()" class="w-full mt-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105">
                        Ulangi Kuis
                    </button>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- LOGIKA NAVIGASI TAB ---
        let activeTab = 'home'; // Mulai dari Beranda

        function switchTab(tabName) {
            activeTab = tabName;

            // Hide All Sections
            document.getElementById('view-simulation').classList.add('hidden');
            document.getElementById('view-materi').classList.add('hidden');
            document.getElementById('view-quiz').classList.add('hidden');
            document.getElementById('view-home').classList.add('hidden');

            // Show Active Section
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            // Khusus Simulasi: Pastikan canvas di-resize dan kontrol zoom terlihat/tersembunyi
            const zoomControls = document.querySelector('#view-simulation .absolute.bottom-6.right-4');
            if(zoomControls) {
                if (tabName === 'simulation') {
                    zoomControls.style.display = 'flex';
                    resizeCanvas();
                } else {
                    zoomControls.style.display = 'none';
                }
            }
            
            // Khusus Kuis: Reset ke tampilan awal kuis (tombol mulai di dalam question-card)
            if(tabName === 'quiz') {
                resetQuizToStartView();
            }
        }

        // --- SIMULASI DAUR AIR (Javascript Canvas) ---
        const canvas = document.getElementById('waterCycleCanvas');
        const ctx = canvas.getContext('2d');
        const WORLD_WIDTH = 1200;
        const WORLD_HEIGHT = 800;
        let width, height, scaleFactor, viewScale = 1.0;
        const SEA_LEVEL = WORLD_HEIGHT * 0.75;
        const GROUND_HEIGHT = WORLD_HEIGHT * 0.85;
        let lastTime = 0, gameTime = 0;
        const CYCLE_DURATION = 120; // 120 detik per siklus siang-malam
        let vapors = [], clouds = [], rains = [], trees = [];

        // Fungsi untuk menyesuaikan ukuran canvas dengan viewport
        function resizeCanvas() {
            // Menggunakan tinggi penuh viewport
            width = window.innerWidth;
            height = window.innerHeight; 
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.scale(dpr, dpr);
            // Menentukan faktor skala untuk menyesuaikan dunia game (WORLD_WIDTH/HEIGHT) ke viewport
            scaleFactor = Math.min(width / WORLD_WIDTH, height / WORLD_HEIGHT);
        }
        window.addEventListener('resize', resizeCanvas);
        // Panggil awal
        setTimeout(resizeCanvas, 100);

        // Kelas untuk uap air (Evaporasi/Transpirasi)
        class Vapor {
            constructor(x, y, forced = false) {
                this.x = x; this.y = y;
                this.radius = Math.random() * 2 + 1;
                this.speedY = Math.random() * 0.5 + 0.5;
                if (forced) this.speedY *= 3; // Lebih cepat jika diklik (paksa)
                this.wobbleOffset = Math.random() * Math.PI * 2;
                this.life = 1.0; this.opacity = Math.random() * 0.4 + 0.3;
            }
            update(dt) {
                this.y -= this.speedY * dt * 60;
                this.x += Math.sin(gameTime * 2 + this.wobbleOffset) * 0.5;
                this.life -= 0.002 * dt * 60;
                if (this.y < SEA_LEVEL * 0.4) this.opacity -= 0.01;
            }
            draw(ctx) {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0, this.opacity * this.life)})`; ctx.fill();
            }
        }

        // Kelas untuk Awan (Kondensasi/Presipitasi)
        class Cloud {
            constructor(x, y) { 
                this.x = x; this.y = y; 
                this.waterContent = 0; 
                this.capacity = 100; 
                this.isRaining = false; 
                this.speed = Math.random() * 0.5 + 0.2;
                // Partikel untuk bentuk awan
                this.particles = Array.from({length: 5}, () => ({x: (Math.random()-0.5)*80, y: (Math.random()-0.5)*30, r: Math.random()*25+25}));
            }
            update(dt) {
                this.x += this.speed * dt * 60;
                // Pindahkan awan ke kiri jika sudah melewati batas kanan
                if (this.x > WORLD_WIDTH + 100) { 
                    this.x = -150; 
                    this.waterContent = 0; 
                    this.isRaining = false; 
                }
                
                // Mulai hujan jika kapasitas penuh
                if (this.waterContent >= this.capacity) this.isRaining = true;

                if (this.isRaining) {
                    this.waterContent -= 0.8 * dt * 60;
                    // Tetesan hujan
                    if (Math.random() > 0.5) rains.push(new Rain(this.x + (Math.random()-0.5)*100, this.y + 20));
                    if (this.waterContent <= 0) { 
                        this.isRaining = false; 
                        this.waterContent = 0; 
                    }
                }
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                // Warna awan menjadi lebih gelap/abu-abu saat air penuh
                const grayVal = Math.floor(255 - ((this.waterContent/this.capacity) * 100));
                ctx.fillStyle = `rgb(${grayVal}, ${grayVal}, ${grayVal})`;
                ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 15; ctx.shadowOffsetY = 10;
                
                // Gambar bentuk awan dari partikel
                ctx.beginPath(); 
                this.particles.forEach(p => { 
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); 
                    ctx.closePath(); 
                }); 
                ctx.fill();
                ctx.restore();
            }
        }

        // Kelas untuk Tetesan Hujan (Presipitasi)
        class Rain {
            constructor(x, y) { 
                this.x = x; this.y = y; 
                this.vy = 8; // Kecepatan awal
                this.len = Math.random() * 10 + 10; 
            }
            update(dt) { 
                this.vy += 0.5 * dt * 60; // Percepatan
                this.y += this.vy * dt * 60; 
            }
            draw(ctx) { 
                ctx.strokeStyle = "rgba(100, 180, 255, 0.8)"; 
                ctx.lineWidth = 2; 
                ctx.beginPath(); 
                ctx.moveTo(this.x, this.y); 
                ctx.lineTo(this.x, this.y + this.len); 
                ctx.stroke(); 
            }
        }

        // Inisialisasi objek di awal simulasi
        function initSim() {
            for(let i=0; i<4; i++) clouds.push(new Cloud(Math.random() * WORLD_WIDTH, 100 + Math.random() * 100));
            // Hutan di sisi daratan
            for(let i=0; i<8; i++) trees.push({x: Math.random() * (WORLD_WIDTH * 0.4), y: GROUND_HEIGHT, type: Math.random() > 0.5 ? 'üå≤' : 'üå≥'});
        }

        // Logika update per frame
        function updateSim(dt) {
            gameTime += dt;
            const cycleProgress = (gameTime % CYCLE_DURATION) / CYCLE_DURATION;
            const isDay = cycleProgress > 0.25 && cycleProgress < 0.75;
            
            // Update Label Waktu (Siang/Malam/Fajar/Senja)
            let timeLabel;
            if (cycleProgress < 0.2) timeLabel = "Malam üåô";
            else if (cycleProgress < 0.3) timeLabel = "Terbit üåÖ";
            else if (cycleProgress < 0.7) timeLabel = "Siang ‚òÄÔ∏è";
            else if (cycleProgress < 0.8) timeLabel = "Terbenam üåá";
            else timeLabel = "Malam üåô";
            document.getElementById('day-night-status').innerText = `Waktu: ${timeLabel}`;

            // Evaporasi Otomatis saat Siang Hari
            if (isDay && Math.random() < 0.1) {
                // Evaporasi dari laut (sisi kanan)
                const vaporX = (WORLD_WIDTH * 0.4) + Math.random() * (WORLD_WIDTH * 0.6);
                vapors.push(new Vapor(vaporX, SEA_LEVEL + 10 + Math.random()*50));
            }
            // Transpirasi (dari pohon)
            if (isDay && Math.random() < 0.05) {
                const randomTree = trees[Math.floor(Math.random() * trees.length)];
                vapors.push(new Vapor(randomTree.x, randomTree.y - 40));
            }

            // Update uap air dan Kondensasi
            vapors = vapors.filter(v => {
                v.update(dt);
                // Cek jika uap mencapai ketinggian awan (Kondensasi)
                if (v.y < 250) {
                    for (let c of clouds) {
                        if (Math.abs(c.x - v.x) < 80 && c.waterContent < c.capacity) {
                            c.waterContent += 2; // Menambah air ke awan
                            return false; // Hapus uap karena sudah berkondensasi
                        }
                    }
                }
                return v.life > 0 && v.y > -50;
            });
            
            // Update Awan dan Hujan
            clouds.forEach(c => c.update(dt));
            
            // Update hujan dan Infiltrasi
            rains = rains.filter(r => { 
                r.update(dt); 
                // Hujan yang mencapai tanah atau laut akan dihilangkan (Infiltrasi/Runoff)
                return r.y < WORLD_HEIGHT; 
            });
        }

        // Helper function untuk menggambar label di dunia canvas
        function drawLabel(ctx, text, x, y, color = 'white') {
            ctx.save();
            ctx.fillStyle = color;
            ctx.shadowColor = "rgba(0,0,0,0.5)"; 
            ctx.shadowBlur = 5; 
            ctx.font = "bold 20px Inter";
            ctx.textAlign = "center";
            ctx.fillText(text, x, y);
            ctx.restore();
        }

        // Fungsi gambar per frame
        function drawSim() {
            // Hanya gambar jika tab simulasi aktif
            if(activeTab !== 'simulation') return;

            const currentScale = scaleFactor * viewScale;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            // Pindah ke pusat canvas, skala, lalu pindah kembali ke asal dunia game
            ctx.translate(width/2, height/2);
            ctx.scale(currentScale, currentScale);
            ctx.translate(-WORLD_WIDTH/2, -WORLD_HEIGHT/2);

            // Background Langit (Siklus Siang-Malam)
            const cycleProgress = (gameTime % CYCLE_DURATION) / CYCLE_DURATION;
            let topColor, bottomColor;
            if (cycleProgress < 0.2) { topColor = "#020024"; bottomColor = "#090979"; } // Malam
            else if (cycleProgress < 0.3) { topColor = "#5f2c82"; bottomColor = "#fdc830"; } // Fajar
            else if (cycleProgress < 0.7) { topColor = "#2980b9"; bottomColor = "#87CEEB"; } // Siang
            else if (cycleProgress < 0.8) { topColor = "#2c3e50"; bottomColor = "#fd746c"; } // Senja
            else { topColor = "#020024"; bottomColor = "#090979"; } // Kembali Malam
            
            const grad = ctx.createLinearGradient(0, 0, 0, WORLD_HEIGHT);
            grad.addColorStop(0, topColor); grad.addColorStop(1, bottomColor);
            ctx.fillStyle = grad; ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);

            // Objek Langit (Matahari/Bulan)
            const cx = WORLD_WIDTH/2 + Math.cos((cycleProgress * Math.PI * 2) - Math.PI/2) * (WORLD_WIDTH*0.8);
            const cy = WORLD_HEIGHT*1.2 + Math.sin((cycleProgress * Math.PI * 2) - Math.PI/2) * (WORLD_WIDTH*0.8);
            ctx.font = "80px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(cycleProgress > 0.2 && cycleProgress < 0.8 ? "‚òÄÔ∏è" : "üåô", cx, cy);

            // Daratan
            ctx.fillStyle = "#4a7c59"; // Warna hijau tanah
            ctx.beginPath(); 
            ctx.moveTo(0, WORLD_HEIGHT); 
            ctx.lineTo(0, WORLD_HEIGHT*0.5); // Mulai dari sisi kiri
            // Bentuk bukit/gunung
            ctx.bezierCurveTo(WORLD_WIDTH*0.1, WORLD_HEIGHT*0.3, WORLD_WIDTH*0.3, WORLD_HEIGHT*0.9, WORLD_WIDTH*0.45, SEA_LEVEL+20);
            ctx.lineTo(WORLD_WIDTH*0.45, WORLD_HEIGHT); 
            ctx.fill();
            
            // VISUALISASI INFILTRASI/AIR TANAH
            // Air Tanah (Groundwater / Infiltrasi)
            ctx.fillStyle = "#87ceebaa"; // Light blue semi-transparent for groundwater
            ctx.beginPath();
            ctx.moveTo(0, GROUND_HEIGHT);
            ctx.lineTo(WORLD_WIDTH * 0.45, SEA_LEVEL + 20); // Mengalir ke laut
            ctx.lineTo(WORLD_WIDTH * 0.45, WORLD_HEIGHT);
            ctx.lineTo(0, WORLD_HEIGHT);
            ctx.fill();

            // Laut (di sisi kanan)
            ctx.fillStyle = "rgba(30, 144, 255, 0.8)"; 
            ctx.fillRect(WORLD_WIDTH*0.4, SEA_LEVEL, WORLD_WIDTH*0.6, WORLD_HEIGHT-SEA_LEVEL);

            // Pohon (Transpirasi)
            ctx.font = "40px Arial"; 
            trees.forEach(t => ctx.fillText(t.type, t.x, t.y-10));

            // Objek Daur Air
            vapors.forEach(v => v.draw(ctx)); 
            clouds.forEach(c => c.draw(ctx)); 
            rains.forEach(r => r.draw(ctx));

            // LABEL TAHAP SIKLUS
            drawLabel(ctx, "KONDENSASI / PEMBENTUKAN AWAN", WORLD_WIDTH * 0.5, 150, 'white');
            drawLabel(ctx, "PRESIPITASI / HUJAN", WORLD_WIDTH * 0.3, 350, '#90ee90');
            drawLabel(ctx, "TRANSPIRASI (Penguapan dari Tumbuhan)", WORLD_WIDTH * 0.15, GROUND_HEIGHT - 60, 'lightgreen');
            drawLabel(ctx, "EVAPORASI / PENGUAPAN (dari Air)", WORLD_WIDTH * 0.7, SEA_LEVEL + 50, 'yellow');
            drawLabel(ctx, "RUNOFF / ALIRAN PERMUKAAN (Ke Laut)", WORLD_WIDTH * 0.3, SEA_LEVEL - 50, '#00bfff');
            drawLabel(ctx, "INFILTRASI / AIR TANAH", WORLD_WIDTH * 0.1, GROUND_HEIGHT + 30, '#87CEEB');

            ctx.restore();
        }

        // Loop animasi utama
        function animateSim(timestamp) {
            const dt = (timestamp - lastTime) / 1000 || 0;
            lastTime = timestamp;
            updateSim(dt);
            drawSim();
            requestAnimationFrame(animateSim);
        }

        // Input Handling Simulasi (Klik/Sentuh)
        function handleSimInput(e) {
            if(activeTab !== 'simulation') return;
            e.preventDefault(); // Mencegah scrolling pada touch

            const rect = canvas.getBoundingClientRect();
            // Handle baik mouse maupun touch
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            const currentScale = scaleFactor * viewScale;
            // Konversi koordinat layar ke koordinat dunia game.
            const worldX = (x - width/2) / currentScale + WORLD_WIDTH/2;
            const worldY = (y - height/2) / currentScale + WORLD_HEIGHT/2;

            // 1. Klik di Laut/Air (Evaporasi Paksa)
            if (worldX > WORLD_WIDTH * 0.4 && worldY > SEA_LEVEL) {
                for(let i=0; i<5; i++) vapors.push(new Vapor(worldX + (Math.random()-0.5)*50, worldY, true));
                showClickEffect(clientX, clientY, "Evaporasi Cepat!");
            }
            // 2. Klik di Awan (Presipitasi Paksa)
            clouds.forEach(c => {
                // Jarak ke pusat awan
                if (Math.sqrt((worldX - c.x)**2 + (worldY - c.y)**2) < 80) {
                    c.waterContent = c.capacity; c.isRaining = true;
                    showClickEffect(clientX, clientY, "Hujan Paksa!");
                }
            });
        }
        canvas.addEventListener('mousedown', handleSimInput);
        canvas.addEventListener('touchstart', handleSimInput, {passive: false});
        
        // Efek visual klik
        function showClickEffect(x, y, text) {
            const el = document.createElement('div');
            el.className = 'absolute text-blue-600 font-bold text-lg pointer-events-none animate-bounce z-50';
            el.style.left = x + 'px'; 
            el.style.top = y + 'px'; 
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        
        // Kontrol Zoom
        document.getElementById('zoomInBtn').onclick = () => viewScale = Math.min(viewScale + 0.2, 3);
        document.getElementById('zoomOutBtn').onclick = () => viewScale = Math.max(viewScale - 0.2, 0.5);

        // --- LOGIKA KUIS (10 Soal) ---
        const quizData = [
            // Soal 1-5 (Dasar)
            { q: "Apa nama proses air laut berubah menjadi uap oleh panas matahari?", a: ["Kondensasi", "Evaporasi", "Presipitasi", "Transpirasi"], correct: 1 },
            { q: "Apa yang terjadi saat uap air naik dan mendingin di atmosfer?", a: ["Membentuk Awan (Kondensasi)", "Mencair jadi es", "Langsung jatuh ke tanah", "Menguap kembali"], correct: 0 },
            { q: "Air yang jatuh dari awan ke bumi dalam bentuk hujan atau salju disebut...", a: ["Transpirasi", "Presipitasi", "Iritasi", "Sublimasi"], correct: 1 },
            { q: "Air hujan yang meresap masuk ke dalam tanah disebut...", a: ["Run off", "Evaporasi", "Infiltrasi", "Kondensasi"], correct: 2 },
            { q: "Apa sumber energi utama yang menggerakkan siklus air?", a: ["Angin", "Bulan", "Matahari", "Gravitasi"], correct: 2 },
            // Soal 6-10 (Tambahan)
            { q: "Proses penguapan air dari permukaan daun tumbuhan disebut?", a: ["Evaporasi", "Kondensasi", "Transpirasi", "Presipitasi"], correct: 2 },
            { q: "Di manakah air paling banyak mengalami evaporasi?", a: ["Hutan", "Gurun", "Pegunungan", "Laut"], correct: 3 },
            { q: "Ketika uap air berubah menjadi titik-titik air kecil yang membentuk awan, proses ini dinamakan...", a: ["Infiltrasi", "Sublimasi", "Kondensasi", "Perkolasi"], correct: 2 },
            { q: "Pergerakan air di permukaan bumi setelah hujan turun yang menuju ke sungai atau laut disebut...", a: ["Infiltrasi", "Runoff", "Aerosol", "Ablasi"], correct: 1 },
            { q: "Air tanah yang mengalir kembali ke laut secara bawah tanah disebut...", a: ["Drainase", "Sublimasi", "Runoff Permukaan", "Perkolasi"], correct: 3 }
        ];

        let currentQ = 0;
        let score = 0;
        
        // Fungsi untuk mengelola tampilan 2 Status Kuis (Pertanyaan atau Hasil)
        function showQuizState(stateName) {
            const questionCard = document.getElementById('question-card');
            const resultCard = document.getElementById('result-card');

            if (stateName === 'question') {
                questionCard.classList.remove('hidden');
                resultCard.classList.add('hidden');
            } else if (stateName === 'result') {
                questionCard.classList.add('hidden');
                resultCard.classList.remove('hidden');
            }
        }

        // Dipanggil saat tombol "Mulai Kuis" atau "Ulangi Kuis" (dari hasil) ditekan
        window.startQuiz = function() {
            currentQ = 0;
            score = 0;
            renderQuestion();
        }
        
        // Fungsi untuk reset ke tampilan awal (Tombol Mulai)
        function resetQuizToStartView() {
            showQuizState('question');
            document.getElementById('result-card').classList.add('hidden'); // Pastikan hasil tersembunyi

            // Reset tampilan question-card ke tombol Mulai
            document.getElementById('q-text').innerText = "Kamu siap menguji pengetahuanmu? Tekan tombol Mulai Kuis di bawah.";
            document.getElementById('q-progress').innerText = `Total Soal: 10`;
            document.getElementById('q-score').innerText = `Skor: 0`;

            const optsContainer = document.getElementById('q-options');
            optsContainer.innerHTML = '';
            
            // Re-inject tombol Mulai Kuis
            const btn = document.createElement('button');
            btn.className = "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105";
            btn.innerText = "Mulai Kuis";
            btn.onclick = startQuiz;
            optsContainer.appendChild(btn);

            document.getElementById('view-quiz').scrollTo({ top: 0, behavior: 'smooth' });
        }


        // Menampilkan pertanyaan kuis saat ini (Status Pertanyaan)
        function renderQuestion() {
            showQuizState('question');
            
            const data = quizData[currentQ];
            document.getElementById('q-text').innerText = data.q;
            document.getElementById('q-progress').innerText = `Pertanyaan ${currentQ + 1}/${quizData.length}`;
            document.getElementById('q-score').innerText = `Skor: ${score}`;
            
            const optsContainer = document.getElementById('q-options');
            optsContainer.innerHTML = '';
            
            data.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(idx);
                optsContainer.appendChild(btn);
            });
            
            document.getElementById('view-quiz').scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Menangani jawaban user
        function handleAnswer(idx) {
            document.querySelectorAll('#q-options button').forEach(btn => btn.disabled = true);

            if (idx === quizData[currentQ].correct) {
                score++;
                document.querySelectorAll('#q-options button')[idx].classList.add('bg-green-100', 'border-green-500');
            } else {
                document.querySelectorAll('#q-options button')[idx].classList.add('bg-red-100', 'border-red-500');
                document.querySelectorAll('#q-options button')[quizData[currentQ].correct].classList.add('bg-green-200', 'border-green-600');
            }

            // Lanjut ke pertanyaan berikutnya setelah jeda
            setTimeout(() => {
                currentQ++;
                if (currentQ < quizData.length) {
                    renderQuestion();
                } else {
                    showResult();
                }
            }, 800);
        }

        // Menampilkan hasil akhir kuis (Status Hasil)
        function showResult() {
            showQuizState('result');

            document.getElementById('final-score').innerText = `${score} / ${quizData.length}`;
            
            let title = "Bagus!";
            let emoji = "üëç";
            if(score === quizData.length) { title = "Sempurna!"; emoji = "üåü"; }
            else if(score <= 5) { title = "Ayo Coba Lagi!"; emoji = "üìö"; }
            
            document.getElementById('result-title').innerText = title;
            document.getElementById('result-emoji').innerText = emoji;
        }

        // Fungsi global untuk memulai ulang kuis (Kembali ke Layer 1)
        window.restartQuiz = function() {
            resetQuizToStartView();
        }

        // --- START APP ---
        window.onload = function() {
            initSim();
            animateSim(0);
            // Default tab is home
            switchTab('home');
        }
    </script>
</body>
</html>
